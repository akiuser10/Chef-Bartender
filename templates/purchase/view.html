{% extends "base.html" %}
{% block page_panel %}
<div class="panel-header">
    <h2>Purchase Request Details</h2>
    <div class="panel-header-actions">
        <a href="{{ url_for('purchase.to_order') }}" class="btn btn-action">Back to To Order</a>
    </div>
</div>

{% if current_user.user_role == 'Manager' and purchase_request.status == 'Pending Manager Approval' %}
<div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 15px; margin-bottom: 20px;">
    <strong>⚠️ Manager Approval Required</strong>
    <p style="margin: 10px 0 0 0;">Review this order and modify quantities as needed. Set quantity to 0 to remove an item. Click "Approve Order" to forward it to the Purchase Manager.</p>
</div>
{% endif %}

{# Group items by supplier #}
{% set suppliers = {} %}
{% for item in purchase_request.items %}
    {% set supplier_name = item.supplier or 'N/A' %}
    {% if supplier_name not in suppliers %}
        {% set _ = suppliers.update({supplier_name: []}) %}
    {% endif %}
    {% set _ = suppliers[supplier_name].append(item) %}
{% endfor %}

{% for supplier_name, supplier_items in suppliers.items() %}
{% set supplier_status = purchase_request.get_supplier_status(supplier_name) %}
{% set supplier_id = supplier_name|replace(' ', '_')|replace('/', '_')|replace('\\', '_')|replace('.', '_')|replace('-', '_') %}
<div class="purchase-details" id="supplier_{{ supplier_id }}" style="margin-bottom: 40px;">
    <div class="purchase-header-info">
        <div class="info-row">
            <strong>Supplier:</strong> <span style="font-size: 1.2em; font-weight: bold; color: #ffd700;">{{ supplier_name }}</span>
        </div>
        <div class="info-row">
            <strong>Order Number:</strong> {{ purchase_request.order_number }}
        </div>
        <div class="info-row">
            <strong>Ordered Date & Time:</strong> {{ purchase_request.ordered_date.strftime('%Y-%m-%d %H:%M:%S') }}
        </div>
        {% set supplier_received_date = purchase_request.get_supplier_received_date(supplier_name) %}
        {% if supplier_received_date %}
        <div class="info-row">
            <strong>Received Date & Time:</strong> {{ supplier_received_date }}
        </div>
        {% endif %}
        <div class="info-row">
            <strong>Created By:</strong> 
            {% if purchase_request.creator %}
                {{ purchase_request.creator.first_name }} {{ purchase_request.creator.last_name if purchase_request.creator.last_name else '' }}
            {% else %}
                Unknown
            {% endif %}
        </div>
        <div class="info-row">
            <strong>Status:</strong> 
            <span class="status-badge status-{{ supplier_status.lower().replace(' ', '-') }}">
                {{ supplier_status }}
            </span>
            {% if current_user.user_role == 'Manager' and purchase_request.status == 'Pending Manager Approval' %}
            <span style="margin-left: 10px; color: #ffc107;">(Pending Your Approval)</span>
            {% elif current_user.user_role == 'Purchase Manager' %}
                {% if supplier_status == 'Pending' %}
                <form method="POST" action="{{ url_for('purchase.update_supplier_status', purchase_id=purchase_request.id) }}" style="display: inline; margin-left: 10px;">
                    <input type="hidden" name="supplier" value="{{ supplier_name }}">
                    <input type="hidden" name="status" value="Order Placed">
                    <button type="submit" class="btn btn-action" style="margin-left: 10px;">Mark as Order Placed</button>
                </form>
                {% endif %}
                {% if supplier_status == 'Order Placed' %}
                <form method="POST" action="{{ url_for('purchase.update_supplier_status', purchase_id=purchase_request.id) }}" style="display: inline; margin-left: 10px;">
                    <input type="hidden" name="supplier" value="{{ supplier_name }}">
                    <input type="hidden" name="status" value="Order Received">
                    <button type="submit" class="btn btn-action" style="margin-left: 10px;">Mark as Order Received</button>
                </form>
                {% endif %}
            {% elif current_user.user_role == 'Manager' %}
                {% if supplier_status in ['Pending', 'Order Placed'] %}
                <form method="POST" action="{{ url_for('purchase.update_supplier_status', purchase_id=purchase_request.id) }}" style="display: inline; margin-left: 10px;">
                    <input type="hidden" name="supplier" value="{{ supplier_name }}">
                    <input type="hidden" name="status" value="Order Received">
                    <button type="submit" class="btn btn-action" style="margin-left: 10px;">Mark as Order Received</button>
                </form>
                {% endif %}
                {% if supplier_status == 'Order Received' %}
                <form method="POST" action="{{ url_for('purchase.update_supplier_status', purchase_id=purchase_request.id) }}" style="display: inline; margin-left: 10px;">
                    <input type="hidden" name="supplier" value="{{ supplier_name }}">
                    <input type="hidden" name="status" value="Order Placed">
                    <button type="submit" class="btn btn-action" style="margin-left: 10px; background-color: #ffc107;">Revert to Order Placed</button>
                </form>
                {% endif %}
            {% endif %}
            {% if current_user.user_role in ['Purchase Manager', 'Chef', 'Bartender', 'Manager'] %}
                {% if supplier_status != 'Order Cancelled' %}
                <form method="POST" action="{{ url_for('purchase.update_supplier_status', purchase_id=purchase_request.id) }}" style="display: inline; margin-left: 10px;">
                    <input type="hidden" name="supplier" value="{{ supplier_name }}">
                    <input type="hidden" name="status" value="Order Cancelled">
                    <button type="submit" class="btn btn-action" style="margin-left: 10px; background-color: #dc3545;">Cancel Order</button>
                </form>
                {% endif %}
            {% endif %}
        </div>
        {% if supplier_status == 'Order Received' %}
        {% set supplier_invoice = purchase_request.get_supplier_invoice(supplier_name) %}
        <div class="info-row">
            <strong>Invoice Number:</strong>
            <input type="text" name="invoice_number_{{ supplier_name }}" form="quantitiesForm_{{ supplier_name }}" 
                   value="{{ supplier_invoice.invoice_number or '' }}" 
                   placeholder="Enter Invoice Number" 
                   style="padding: 5px 10px; margin-left: 10px; border: 1px solid #3a3a3a; background: #1a1a1a; color: white; border-radius: 4px; min-width: 200px;">
        </div>
        <div class="info-row">
            <strong>Invoice Value:</strong>
            <input type="text" name="invoice_value_{{ supplier_name }}" form="quantitiesForm_{{ supplier_name }}" 
                   value="{{ "%.2f"|format(supplier_invoice.invoice_value) if supplier_invoice.invoice_value else '' }}" 
                   placeholder="Enter Invoice Value" 
                   style="padding: 5px 10px; margin-left: 10px; border: 1px solid #3a3a3a; background: #1a1a1a; color: white; border-radius: 4px; min-width: 200px;">
        </div>
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('purchase.update_quantities', purchase_id=purchase_request.id) }}" id="quantitiesForm_{{ supplier_name }}">
    <input type="hidden" name="supplier" value="{{ supplier_name }}">
    <div class="table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Description</th>
                    <th>Quantity</th>
                    <th>Supplier</th>
                    <th>Sub Category</th>
                    <th>Cost per Unit</th>
                    <th>Order Quantity</th>
                    <th>Total Cost</th>
                    {% if supplier_status == 'Order Received' %}
                    <th>Quantity Received</th>
                    <th>Total Cost (Received)</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in supplier_items %}
                <tr>
                    <td>{{ item.code or 'N/A' }}</td>
                    <td>{{ item.description }}</td>
                    <td>{{ "%.2f"|format(item.quantity) }}</td>
                    <td>{{ item.supplier or 'N/A' }}</td>
                    <td>{{ item.sub_category or 'Other' }}</td>
                    <td>{{ user_currency_info.symbol }} {{ "%.2f"|format(item.cost_per_unit) }}</td>
                    <td>
                        {% if current_user.user_role == 'Manager' and purchase_request.status == 'Pending Manager Approval' %}
                        <input type="text" step="0.01" min="0" name="order_quantity_{{ item.id }}" 
                               value="{{ "%.2f"|format(item.order_quantity) }}" 
                               form="approveForm"
                               class="table-input table-input-right table-input-quantity" 
                               title="Order quantity for {{ item.description }}"
                               placeholder="0.00"
                               aria-label="Order quantity for {{ item.description }}"
                               required>
                        <small class="quantity-hint">
                            Set to 0 to remove
                        </small>
                        {% else %}
                        <strong>{{ "%.2f"|format(item.order_quantity) }}</strong>
                        {% endif %}
                    </td>
                    <td>
                        <strong>
                            {% if current_user.user_role == 'Manager' and purchase_request.status == 'Pending Manager Approval' %}
                            <span id="total_cost_{{ item.id }}">{{ user_currency_info.symbol }} {{ "%.2f"|format(item.cost_per_unit * item.order_quantity) }}</span>
                            {% else %}
                            {{ user_currency_info.symbol }} {{ "%.2f"|format(item.cost_per_unit * item.order_quantity) }}
                            {% endif %}
                        </strong>
                    </td>
                    {% if supplier_status == 'Order Received' %}
                    <td>
                        <input type="number" step="0.01" min="0" name="quantity_received_{{ item.id }}" 
                               value="{{ "%.2f"|format(item.quantity_received) if item.quantity_received is not none else '' }}" 
                               placeholder="0.00" class="table-input table-input-right">
                    </td>
                    <td><strong>{{ user_currency_info.symbol }} {{ "%.2f"|format(item.calculate_received_cost()) }}</strong></td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="{% if supplier_status == 'Order Received' %}9{% else %}7{% endif %}">
                        {% set supplier_total_list = [] %}
                        {% for item in supplier_items %}
                            {% set item_total_cost = (item.cost_per_unit or 0) * (item.order_quantity or 0) %}
                            {% set _ = supplier_total_list.append(item_total_cost) %}
                        {% endfor %}
                        {% set supplier_total = supplier_total_list | sum %}
                        <strong>Total Cost (Ordered):</strong> {{ user_currency_info.symbol }} {{ "%.2f"|format(supplier_total) }}
                        {% if supplier_status == 'Order Received' %}
                        {% set supplier_received_total_list = [] %}
                        {% for item in supplier_items %}
                            {% set item_received_cost = item.calculate_received_cost() %}
                            {% set _ = supplier_received_total_list.append(item_received_cost) %}
                        {% endfor %}
                        {% set supplier_received_total = supplier_received_total_list | sum %}
                        <br>
                        <strong>Total Cost (Received):</strong> {{ user_currency_info.symbol }} {{ "%.2f"|format(supplier_received_total) }}
                        <br>
                        {% set variance = supplier_total - supplier_received_total %}
                        {% if variance != 0 %}
                            {% if variance > 0 %}
                            <strong class="variance-positive">
                                Variance: {{ user_currency_info.symbol }} {{ "%.2f"|format(variance) }}
                                (Ordered more than received)
                            </strong>
                            {% else %}
                            <strong class="variance-negative">
                                Variance: {{ user_currency_info.symbol }} {{ "%.2f"|format(variance) }}
                                (Received more than ordered)
                            </strong>
                            {% endif %}
                        {% else %}
                        <strong class="variance-zero">Variance: {{ user_currency_info.symbol }} 0.00 (No variance)</strong>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
    {% if supplier_status == 'Order Received' %}
        <div class="actions purchase-actions">
            <button type="submit" class="btn btn-primary">Update Quantities</button>
        </div>
    {% endif %}
    </form>
</div>
{% endfor %}

{% if current_user.user_role == 'Manager' and purchase_request.status == 'Pending Manager Approval' %}
<div style="text-align: center; margin: 40px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
    <form id="approveForm" method="POST" action="{{ url_for('purchase.approve_purchase_request', purchase_id=purchase_request.id) }}" style="display: inline;">
        <button type="submit" class="btn btn-primary" style="font-size: 16px; padding: 12px 30px; background-color: #28a745;">
            ✓ Approve Order & Forward to Purchase Manager
        </button>
    </form>
</div>
{% endif %}

{# Check if all suppliers have received dates #}
{% set all_suppliers_received = true %}
{% for supplier_name in suppliers.keys() %}
    {% set supplier_received_date = purchase_request.get_supplier_received_date(supplier_name) %}
    {% if not supplier_received_date %}
        {% set all_suppliers_received = false %}
    {% endif %}
{% endfor %}

{% if all_suppliers_received and suppliers %}
<div class="pdf-generate-container">
    <a href="{{ url_for('purchase.export_purchase_pdf', purchase_id=purchase_request.id) }}" class="btn btn-primary btn-generate-pdf">
        Generate PDF
    </a>
</div>
{% endif %}

<script>
// Scroll to supplier section if anchor is present in URL
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash && hash.startsWith('#supplier_')) {
        const targetId = hash.substring(1); // Remove the #
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
            // Small delay to ensure page is fully rendered
            setTimeout(function() {
                // Scroll to the bottom of the supplier table section
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                // Scroll to bottom of page to show the table at the bottom
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 100);
        }
    }
    
    // Auto-calculate total cost when order quantity changes (for Manager approval)
    var isManagerApproval = {% if current_user.user_role == 'Manager' and purchase_request.status == 'Pending Manager Approval' %}true{% else %}false{% endif %};
    if (isManagerApproval) {
        const quantityInputs = document.querySelectorAll('input[name^="order_quantity_"]');
        quantityInputs.forEach(function(input) {
            input.addEventListener('input', function() {
                const itemId = this.name.replace('order_quantity_', '');
                const quantity = parseFloat(this.value) || 0;
                const costPerUnit = parseFloat(this.closest('tr').querySelector('td:nth-child(7)').textContent.replace(/[^\d.]/g, '')) || 0;
                const totalCost = quantity * costPerUnit;
                const totalCostElement = document.getElementById('total_cost_' + itemId);
                if (totalCostElement) {
                    totalCostElement.textContent = '{{ user_currency_info.symbol }} ' + totalCost.toFixed(2);
                }
            });
        });
    }
});
</script>
{% endblock %}
