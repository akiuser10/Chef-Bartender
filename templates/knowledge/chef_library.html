{% extends "base.html" %}
{% block page_panel %}
<div class="panel-header">
    <h2>Chef Library</h2>
</div>

<div class="library-container">
    <div class="books-grid">
        {% if current_user.user_role == 'Manager' %}
        <!-- Add Book Button -->
        <div class="book-card add-book-card" 
             id="addBookCard" 
             onclick="openAddBookModal('chef')"
             ondrop="handleDrop(event, 'chef')" 
             ondragover="handleDragOver(event)" 
             ondragenter="handleDragEnter(event)" 
             ondragleave="handleDragLeave(event)">
            <div class="add-book-button">
                <span class="plus-icon">+</span>
                <span class="drag-drop-hint" style="display: none; font-size: 0.7rem; margin-top: 10px; color: #d45a2a;">Drop PDF here</span>
            </div>
        </div>
        {% endif %}
        
        <!-- Book Cards -->
        {% for book in books %}
        <div class="book-card">
            <a href="{{ url_for('knowledge.view_book_pdf', book_id=book.id) }}" target="_blank" class="book-link">
                {% if book.cover_image_path %}
                {% set cover_path = book.cover_image_path.replace('uploads/', '', 1) if book.cover_image_path.startswith('uploads/') else book.cover_image_path %}
                <img src="{{ url_for('main.uploaded_file', filename=cover_path) }}" alt="{{ book.title }}" class="book-cover">
                {% else %}
                <div class="book-cover-placeholder">
                    <span class="book-icon">üìö</span>
                </div>
                {% endif %}
                <div class="book-info">
                    <h3 class="book-title">{{ book.title }}</h3>
                </div>
            </a>
            {% if current_user.user_role == 'Manager' %}
            <div class="book-actions">
                <button class="btn-edit" onclick="openEditBookModal({{ book.id }}, '{{ book.title|e }}', 'chef')" title="Edit Book">
                    ‚úèÔ∏è
                </button>
                <button class="btn-delete" onclick="confirmDeleteBook({{ book.id }}, 'chef')" title="Delete Book">
                    üóëÔ∏è
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Book Modal -->
{% if current_user.user_role == 'Manager' %}
<div id="addBookModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAddBookModal()">&times;</span>
        <h2>Add New Book</h2>
        <form action="{{ url_for('knowledge.add_book') }}" method="POST" enctype="multipart/form-data" id="addBookForm">
            <input type="hidden" name="library_type" id="modalLibraryType" value="chef">
            
            <div class="form-group">
                <label for="book_title">Title (Optional - will use first 3 words of PDF filename if not provided)</label>
                <input type="text" id="book_title" name="title">
            </div>
            
            <div class="form-group">
                <label for="cover_image">Cover Image (Optional)</label>
                <input type="file" id="cover_image" name="cover_image" accept="image/*">
            </div>
            
            <div class="form-group">
                <label for="pdf_file">PDF File *</label>
                <input type="file" id="pdf_file" name="pdf_file" accept=".pdf" required>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddBookModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Book</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Book Modal -->
<div id="editBookModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeEditBookModal()">&times;</span>
        <h2>Edit Book</h2>
        <form action="" method="POST" enctype="multipart/form-data" id="editBookForm">
            <input type="hidden" id="editBookId" name="book_id">
            
            <div class="form-group">
                <label for="edit_book_title">Title *</label>
                <input type="text" id="edit_book_title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="edit_cover_image">Cover Image (Optional - leave empty to keep current)</label>
                <input type="file" id="edit_cover_image" name="cover_image" accept="image/*">
            </div>
            
            <div class="form-group">
                <label for="edit_pdf_file">PDF File (Optional - leave empty to keep current)</label>
                <input type="file" id="edit_pdf_file" name="pdf_file" accept=".pdf">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditBookModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Book</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
function openAddBookModal(libraryType) {
    document.getElementById('modalLibraryType').value = libraryType;
    document.getElementById('addBookModal').style.display = 'block';
}

function closeAddBookModal() {
    document.getElementById('addBookModal').style.display = 'none';
    document.getElementById('addBookForm').reset();
}

function openEditBookModal(bookId, title, libraryType) {
    document.getElementById('editBookId').value = bookId;
    document.getElementById('edit_book_title').value = title;
    document.getElementById('editBookForm').action = '{{ url_for("knowledge.edit_book", book_id=0) }}'.replace('0', bookId);
    document.getElementById('editBookModal').style.display = 'block';
}

function closeEditBookModal() {
    document.getElementById('editBookModal').style.display = 'none';
    document.getElementById('editBookForm').reset();
}

function confirmDeleteBook(bookId, libraryType) {
    if (confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("knowledge.delete_book", book_id=0) }}'.replace('0', bookId);
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addBookModal');
    const editModal = document.getElementById('editBookModal');
    if (event.target == addModal) {
        closeAddBookModal();
    }
    if (event.target == editModal) {
        closeEditBookModal();
    }
}

// Drag and Drop functionality
function handleDragOver(event) {
    event.preventDefault();
    event.stopPropagation();
    event.dataTransfer.dropEffect = 'copy';
}

function handleDragEnter(event) {
    event.preventDefault();
    event.stopPropagation();
    const card = event.currentTarget;
    card.classList.add('drag-over');
    const hint = card.querySelector('.drag-drop-hint');
    if (hint) hint.style.display = 'block';
}

function handleDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    const card = event.currentTarget;
    card.classList.remove('drag-over');
    const hint = card.querySelector('.drag-drop-hint');
    if (hint) hint.style.display = 'none';
}

function handleDrop(event, libraryType) {
    event.preventDefault();
    event.stopPropagation();
    
    const card = event.currentTarget;
    card.classList.remove('drag-over');
    const hint = card.querySelector('.drag-drop-hint');
    if (hint) hint.style.display = 'none';
    
    const files = event.dataTransfer.files;
    if (files.length === 0) return;
    
    const file = files[0];
    
    // Check if file is PDF
    if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
        alert('Please drop a PDF file.');
        return;
    }
    
    // Create FormData and submit
    const formData = new FormData();
    formData.append('pdf_file', file);
    formData.append('library_type', libraryType);
    
    // Optional: extract title from filename
    const filename = file.name.replace(/\.pdf$/i, '');
    const titleParts = filename.split(/[_\-\s]+/);
    if (titleParts.length > 2 && /^\d{8}$/.test(titleParts[0]) && /^\d{6}$/.test(titleParts[1])) {
        // Remove timestamp prefix
        titleParts.shift();
        titleParts.shift();
    }
    const title = titleParts.slice(0, 3).join(' ').trim();
    if (title) {
        formData.append('title', title);
    }
    
    // Show loading indicator
    const originalContent = card.innerHTML;
    card.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="color: #d45a2a;">Uploading...</div></div>';
    card.style.pointerEvents = 'none';
    
    // Submit form
    fetch('{{ url_for("knowledge.add_book") }}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.text().then(text => {
                throw new Error('Upload failed');
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        card.innerHTML = originalContent;
        card.style.pointerEvents = 'auto';
        alert('Error uploading book. Please try again.');
    });
}
</script>
{% endblock %}
