{% extends "base.html" %}
{% block page_panel %}
<div class="panel-header">
    <h2>Chef Library</h2>
</div>

<div class="library-container">
    <div class="books-grid">
        {% if current_user.user_role == 'Manager' %}
        <!-- Add Book Button -->
        <div class="book-card add-book-card" onclick="openAddBookModal('chef')">
            <div class="add-book-button">
                <span class="plus-icon">+</span>
            </div>
        </div>
        {% endif %}
        
        <!-- Book Cards -->
        {% for book in books %}
        <div class="book-card">
            <a href="{{ url_for('knowledge.view_book_pdf', book_id=book.id) }}" target="_blank" class="book-link">
                {% if book.cover_image_path %}
                <img src="{{ url_for('main.uploaded_file', filename=book.cover_image_path) }}" alt="{{ book.title }}" class="book-cover">
                {% else %}
                <div class="book-cover-placeholder">
                    <span class="book-icon">üìö</span>
                </div>
                {% endif %}
                <div class="book-info">
                    <h3 class="book-title">{{ book.title }}</h3>
                    {% if book.author %}
                    <p class="book-author">{{ book.author }}</p>
                    {% endif %}
                </div>
            </a>
            {% if current_user.user_role == 'Manager' %}
            <div class="book-actions">
                <button class="btn-edit" onclick="openEditBookModal({{ book.id }}, '{{ book.title|e }}', '{{ book.author|e if book.author else '' }}', 'chef')" title="Edit Book">
                    ‚úèÔ∏è
                </button>
                <button class="btn-delete" onclick="confirmDeleteBook({{ book.id }}, 'chef')" title="Delete Book">
                    üóëÔ∏è
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Book Modal -->
{% if current_user.user_role == 'Manager' %}
<div id="addBookModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAddBookModal()">&times;</span>
        <h2>Add New Book</h2>
        <form action="{{ url_for('knowledge.add_book') }}" method="POST" enctype="multipart/form-data" id="addBookForm">
            <input type="hidden" name="library_type" id="modalLibraryType" value="chef">
            
            <div class="form-group">
                <label for="book_title">Title *</label>
                <input type="text" id="book_title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="book_author">Author</label>
                <input type="text" id="book_author" name="author">
            </div>
            
            <div class="form-group">
                <label for="cover_image">Cover Image (Optional)</label>
                <input type="file" id="cover_image" name="cover_image" accept="image/*">
            </div>
            
            <div class="form-group">
                <label for="pdf_file">PDF File *</label>
                <input type="file" id="pdf_file" name="pdf_file" accept=".pdf" required>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddBookModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Book</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Book Modal -->
<div id="editBookModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeEditBookModal()">&times;</span>
        <h2>Edit Book</h2>
        <form action="" method="POST" enctype="multipart/form-data" id="editBookForm">
            <input type="hidden" id="editBookId" name="book_id">
            
            <div class="form-group">
                <label for="edit_book_title">Title *</label>
                <input type="text" id="edit_book_title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="edit_book_author">Author</label>
                <input type="text" id="edit_book_author" name="author">
            </div>
            
            <div class="form-group">
                <label for="edit_cover_image">Cover Image (Optional - leave empty to keep current)</label>
                <input type="file" id="edit_cover_image" name="cover_image" accept="image/*">
            </div>
            
            <div class="form-group">
                <label for="edit_pdf_file">PDF File (Optional - leave empty to keep current)</label>
                <input type="file" id="edit_pdf_file" name="pdf_file" accept=".pdf">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditBookModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Book</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
function openAddBookModal(libraryType) {
    document.getElementById('modalLibraryType').value = libraryType;
    document.getElementById('addBookModal').style.display = 'block';
}

function closeAddBookModal() {
    document.getElementById('addBookModal').style.display = 'none';
    document.getElementById('addBookForm').reset();
}

function openEditBookModal(bookId, title, author, libraryType) {
    document.getElementById('editBookId').value = bookId;
    document.getElementById('edit_book_title').value = title;
    document.getElementById('edit_book_author').value = author || '';
    document.getElementById('editBookForm').action = '{{ url_for("knowledge.edit_book", book_id=0) }}'.replace('0', bookId);
    document.getElementById('editBookModal').style.display = 'block';
}

function closeEditBookModal() {
    document.getElementById('editBookModal').style.display = 'none';
    document.getElementById('editBookForm').reset();
}

function confirmDeleteBook(bookId, libraryType) {
    if (confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("knowledge.delete_book", book_id=0) }}'.replace('0', bookId);
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addBookModal');
    const editModal = document.getElementById('editBookModal');
    if (event.target == addModal) {
        closeAddBookModal();
    }
    if (event.target == editModal) {
        closeEditBookModal();
    }
}
</script>
{% endblock %}
