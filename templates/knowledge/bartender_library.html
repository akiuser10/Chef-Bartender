{% extends "base.html" %}
{% block page_panel %}
<div class="panel-header">
    <h2>Bartender Library</h2>
</div>

<div class="library-container">
    <div class="books-grid">
        {% if current_user.user_role == 'Manager' %}
        <!-- Add Article Button -->
        <div class="book-card add-book-card" 
             id="addBookCard" 
             onclick="openAddBookModal('bartender')">
            <div class="add-book-button">
                <span class="plus-icon">+</span>
            </div>
        </div>
        {% endif %}
        
        <!-- Article Cards -->
        {% for book in books %}
        <div class="book-card">
            {% if book.article_url %}
            <a href="{{ book.article_url }}" target="_blank" rel="noopener noreferrer" class="book-link">
            {% elif book.pdf_path %}
            <a href="{{ url_for('knowledge.view_book_pdf', book_id=book.id) }}" target="_blank" class="book-link">
            {% else %}
            <div class="book-link">
            {% endif %}
                {% if book.cover_image_path %}
                {% set cover_path = book.cover_image_path.replace('uploads/', '', 1) if book.cover_image_path.startswith('uploads/') else book.cover_image_path %}
                <img src="{{ url_for('main.uploaded_file', filename=cover_path) }}" alt="{{ book.title }}" class="book-cover" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'book-cover-placeholder\'><span class=\'book-icon\'>üìö</span></div>';">
                {% else %}
                <div class="book-cover-placeholder">
                    <span class="book-icon">üìö</span>
                </div>
                {% endif %}
                <div class="book-info">
                    <h3 class="book-title">{{ book.title }}</h3>
                </div>
            {% if book.article_url or book.pdf_path %}
            </a>
            {% else %}
            </div>
            {% endif %}
            {% if current_user.user_role == 'Manager' %}
            <div class="book-actions">
                <button class="btn-edit" 
                        data-book-id="{{ book.id }}" 
                        data-book-title="{{ book.title|e }}" 
                        data-article-url="{{ book.article_url or '' }}"
                        data-library-type="bartender"
                        onclick="openEditBookModal(this)" 
                        title="Edit Article">
                    ‚úèÔ∏è
                </button>
                <button class="btn-delete" 
                        data-book-id="{{ book.id }}" 
                        data-library-type="bartender"
                        onclick="confirmDeleteBook(this)" 
                        title="Delete Book">
                    üóëÔ∏è
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Book Modal -->
{% if current_user.user_role == 'Manager' %}
<div id="addBookModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAddBookModal()">&times;</span>
        <h2>Add New Article</h2>
        <form action="{{ url_for('knowledge.add_book') }}" method="POST" enctype="multipart/form-data" id="addBookForm">
            <input type="hidden" name="library_type" id="modalLibraryType" value="bartender">
            
            <div class="form-group">
                <label for="book_title">Article Title *</label>
                <input type="text" id="book_title" name="title" required placeholder="Enter article title">
            </div>
            
            <div class="form-group">
                <label for="article_url">Article URL *</label>
                <input type="url" id="article_url" name="article_url" required placeholder="https://example.com/article" pattern="https?://.+">
                <small class="form-text">Enter the full website URL to the article</small>
            </div>
            
            <div class="form-group">
                <label for="cover_image">Cover Image (Optional)</label>
                <input type="file" id="cover_image" name="cover_image" accept="image/*">
                <small class="form-text">Upload an image to represent this article</small>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddBookModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Article</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Book Modal -->
<div id="editBookModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeEditBookModal()">&times;</span>
        <h2>Edit Article</h2>
        <form action="" method="POST" enctype="multipart/form-data" id="editBookForm">
            <input type="hidden" id="editBookId" name="book_id">
            
            <div class="form-group">
                <label for="edit_book_title">Article Title *</label>
                <input type="text" id="edit_book_title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="edit_article_url">Article URL *</label>
                <input type="url" id="edit_article_url" name="article_url" required pattern="https?://.+">
                <small class="form-text">Enter the full website URL to the article</small>
            </div>
            
            <div class="form-group">
                <label for="edit_cover_image">Cover Image (Optional - leave empty to keep current)</label>
                <input type="file" id="edit_cover_image" name="cover_image" accept="image/*">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditBookModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Article</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
function openAddBookModal(libraryType) {
    document.getElementById('modalLibraryType').value = libraryType;
    document.getElementById('addBookModal').style.display = 'block';
}

function closeAddBookModal() {
    document.getElementById('addBookModal').style.display = 'none';
    document.getElementById('addBookForm').reset();
}

function openEditBookModal(button) {
    const bookId = button.getAttribute('data-book-id');
    const title = button.getAttribute('data-book-title');
    const articleUrl = button.getAttribute('data-article-url') || '';
    const libraryType = button.getAttribute('data-library-type');
    document.getElementById('editBookId').value = bookId;
    document.getElementById('edit_book_title').value = title;
    document.getElementById('edit_article_url').value = articleUrl;
    document.getElementById('editBookForm').action = '{{ url_for("knowledge.edit_book", book_id=0) }}'.replace('0', bookId);
    document.getElementById('editBookModal').style.display = 'block';
}

function closeEditBookModal() {
    document.getElementById('editBookModal').style.display = 'none';
    document.getElementById('editBookForm').reset();
}

function confirmDeleteBook(button) {
    const bookId = button.getAttribute('data-book-id');
    const libraryType = button.getAttribute('data-library-type');
    if (confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("knowledge.delete_book", book_id=0) }}'.replace('0', bookId);
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addBookModal');
    const editModal = document.getElementById('editBookModal');
    if (event.target == addModal) {
        closeAddBookModal();
    }
    if (event.target == editModal) {
        closeEditBookModal();
    }
}
</script>
{% endblock %}
