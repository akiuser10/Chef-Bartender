{% extends "base.html" %}
{% block page_panel %}
<!-- Hero Section with Slider -->
<div class="hero-section-foodility">
    <div class="hero-slider-container">
        {% if hero_slides %}
            {% for slide in hero_slides %}
                {% if slide.is_active %}
                <div class="hero-slide-foodility {% if loop.first %}active{% endif %}" data-slide="{{ slide.slide_number }}">
                    {% if slide.image_path %}
                    <div class="hero-slide-bg" data-bg-image="{{ url_for('static', filename=slide.image_path) if slide.image_path.startswith('images/') else url_for('main.uploaded_file', filename=slide.image_path.replace('uploads/', '', 1)) }}"></div>
                    {% else %}
                    <div class="hero-slide-bg" data-bg-image="{{ url_for('static', filename='images/hero/green-smoothie.jpg') }}"></div>
                    {% endif %}
                    <div class="hero-content-foodility">
                        <div class="hero-text-container">
                            <h1 class="hero-title-script">{{ slide.title }}</h1>
                            {% if slide.subtitle %}
                            <p class="hero-subtitle">{{ slide.subtitle }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <!-- Fallback slides if no database slides exist -->
            <div class="hero-slide-foodility active" data-slide="0">
                <div class="hero-slide-bg" data-bg-image="{{ url_for('static', filename='images/hero/green-smoothie.jpg') }}"></div>
                <div class="hero-content-foodility">
                    <div class="hero-text-container">
                        <h1 class="hero-title-script">Healthy Smoothie</h1>
                        <p class="hero-subtitle">Fresh ingredients, natural flavors, perfect blend</p>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Navigation Arrows -->
        <button class="carousel-nav-foodility carousel-prev-foodility" aria-label="Previous" id="heroPrevBtnFoodility">‹</button>
        <button class="carousel-nav-foodility carousel-next-foodility" aria-label="Next" id="heroNextBtnFoodility">›</button>
    </div>
    
    <!-- Tasks Showcase Below Hero -->
    {% if tasks %}
    <div class="hero-products-showcase">
        {% for task in tasks %}
        <a href="{{ task.url }}" class="product-bottle-link">
            <div class="product-bottle {{ task.color_class }}">
                <span class="product-bottle-label">
                    {{ task.title }}
                    {% if task.count is not none %}
                        <br>
                        <span class="task-count">{{ task.count }}</span>
                    {% endif %}
                </span>
            </div>
        </a>
        {% endfor %}
        <div class="product-fruits-decoration"></div>
    </div>
    {% else %}
    <div class="task-empty-message" id="task-empty-message">
        Well done, all your tasks have been completed
    </div>
    {% endif %}
</div>

<!-- Recipe Section -->
<section class="beverage-section">
    <div class="section-container">
        <h2 class="section-title">Recent Recipes</h2>
        <div class="beverage-grid">
            {% if recent_recipes %}
                {% for recipe in recent_recipes %}
                <a href="{% if recipe.recipe_code %}{{ url_for('recipes.view_recipe_by_code', code=recipe.recipe_code) }}{% else %}{{ url_for('recipes.view_recipe', id=recipe.id) }}{% endif %}" class="beverage-card recipe-card recipe-card-link">
                    {% if recipe.image_path %}
                        <div class="beverage-image recipe-image recipe-image-with-url" data-image-url="{{ url_for('main.uploaded_file', filename=recipe.image_path) }}"></div>
                    {% else %}
                        {% set color_index = loop.index0 % 8 %}
                        <div class="beverage-image recipe-image recipe-color-{{ color_index }}"></div>
                    {% endif %}
                    <h3 class="beverage-name">{{ recipe.title }}</h3>
                </a>
                {% endfor %}
            {% else %}
                <!-- Placeholder cards when no recipes exist -->
                {% for i in range(8) %}
                <div class="beverage-card recipe-card">
                    <div class="beverage-image recipe-image recipe-color-{{ i }}"></div>
                    <h3 class="beverage-name">No Recipes Yet</h3>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <button class="carousel-nav-foodility beverage-prev">‹</button>
        <button class="carousel-nav-foodility beverage-next">›</button>
    </div>
</section>

<!-- Detox Smoothie Recipe Section -->
<section class="recipe-section">
    <div class="section-container">
        <h2 class="section-title">From Nature, For Life, Through Sustainability</h2>
        <div class="recipe-content">
            <div class="recipe-ingredients">
                <div class="ingredient-item">
                    <div class="ingredient-icon cucumber"></div>
                    <div class="ingredient-text">
                        <h4>Cucumber</h4>
                        <p>Fresh and hydrating</p>
                    </div>
                </div>
                <div class="ingredient-item">
                    <div class="ingredient-icon apple"></div>
                    <div class="ingredient-text">
                        <h4>Apple</h4>
                        <p>Natural sweetness</p>
                    </div>
                </div>
                <div class="ingredient-item">
                    <div class="ingredient-icon lemon"></div>
                    <div class="ingredient-text">
                        <h4>Lemon</h4>
                        <p>Vitamin C boost</p>
                    </div>
                </div>
                <div class="ingredient-item">
                    <div class="ingredient-icon water"></div>
                    <div class="ingredient-text">
                        <h4>Fresh Water</h4>
                        <p>Pure hydration</p>
                    </div>
                </div>
            </div>
            <div class="recipe-bottle">
                <div class="bottle-image"></div>
            </div>
        </div>
    </div>
</section>

<!-- Upcoming Beverage Section -->
<section class="upcoming-section">
    <div class="section-container">
        <h2 class="section-title">Upcoming Our Beverage</h2>
        <div class="upcoming-content">
            <div class="upcoming-text">
                <p>Discover our latest creations and seasonal specials. We're constantly innovating to bring you the freshest, most delicious beverages.</p>
                <p>Stay tuned for exciting new flavors and limited-time offers that celebrate the best of each season.</p>
            </div>
            <div class="upcoming-image">
                <div class="outdoor-drinks-image"></div>
            </div>
        </div>
    </div>
</section>

<!-- Knowledge Hub Section -->
<section class="blog-section knowledge-hub-section">
    <div class="section-container">
        <h2 class="section-title">Knowledge Hub</h2>
        <div class="blog-grid knowledge-hub-grid">
            {% if recent_books %}
                {% for book in recent_books %}
                {# Determine the best link for this book #}
                {% if book.article_url %}
                    {% set book_href = book.article_url %}
                    {% set is_external = true %}
                {% elif book.pdf_path %}
                    {% set book_href = url_for('knowledge.view_book_pdf', book_id=book.id) %}
                    {% set is_external = false %}
                {% else %}
                    {% if book.library_type == 'bartender' %}
                        {% set book_href = url_for('knowledge.bartender_library') %}
                    {% else %}
                        {% set book_href = url_for('knowledge.chef_library') %}
                    {% endif %}
                    {% set is_external = false %}
                {% endif %}

                <a href="{{ book_href }}"
                   class="knowledge-hub-link"
                   {% if is_external %}target="_blank" rel="noopener noreferrer"{% endif %}>
                    {% if book.cover_image_path %}
                        {% set cover_path = book.cover_image_path.replace('uploads/', '', 1) if book.cover_image_path.startswith('uploads/') else book.cover_image_path %}
                        <div class="knowledge-hub-card"
                             data-cover-image="{{ url_for('main.uploaded_file', filename=cover_path) }}">
                            <h3 class="knowledge-hub-title">{{ book.title }}</h3>
                        </div>
                    {% else %}
                        <div class="knowledge-hub-card">
                            <h3 class="knowledge-hub-title">{{ book.title }}</h3>
                        </div>
                    {% endif %}
                </a>
                {% endfor %}
            {% else %}
                <!-- Placeholder cards when no books exist -->
                {% for i in range(3) %}
                <div class="blog-card knowledge-hub-card">
                    <div class="blog-image knowledge-hub-image knowledge-hub-placeholder"></div>
                    <h3 class="blog-title knowledge-hub-title">No Books Yet</h3>
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hero Slider
    const heroSlides = document.querySelectorAll('.hero-slide-foodility');
    const heroPrevBtn = document.getElementById('heroPrevBtnFoodility');
    const heroNextBtn = document.getElementById('heroNextBtnFoodility');
    let currentHeroSlide = 0;
    let heroAutoSlideInterval;
    
    function showHeroSlide(index) {
        heroSlides.forEach(slide => slide.classList.remove('active'));
        if (heroSlides[index]) {
            heroSlides[index].classList.add('active');
        }
    }
    
    function nextHeroSlide() {
        currentHeroSlide = (currentHeroSlide + 1) % heroSlides.length;
        showHeroSlide(currentHeroSlide);
        resetHeroAutoSlide();
    }
    
    function prevHeroSlide() {
        currentHeroSlide = (currentHeroSlide - 1 + heroSlides.length) % heroSlides.length;
        showHeroSlide(currentHeroSlide);
        resetHeroAutoSlide();
    }
    
    function startHeroAutoSlide() {
        if (heroAutoSlideInterval) {
            clearInterval(heroAutoSlideInterval);
        }
        heroAutoSlideInterval = setInterval(nextHeroSlide, 5000);
    }
    
    function resetHeroAutoSlide() {
        startHeroAutoSlide();
    }
    
    if (heroNextBtn) heroNextBtn.addEventListener('click', nextHeroSlide);
    if (heroPrevBtn) heroPrevBtn.addEventListener('click', prevHeroSlide);
    
    startHeroAutoSlide();
    
    // Set background images for recipe cards with images
    document.querySelectorAll('.recipe-image-with-url').forEach(function(img) {
        const imageUrl = img.getAttribute('data-image-url');
        if (imageUrl) {
            img.style.backgroundImage = 'url(' + imageUrl + ')';
        }
    });
    
    // Set background images for hero slides
    document.querySelectorAll('.hero-slide-bg').forEach(function(bg) {
        const imageUrl = bg.getAttribute('data-bg-image');
        if (imageUrl) {
            bg.style.backgroundImage = 'url(' + imageUrl + ')';
        }
    });
    
    // Set background images for knowledge hub book cards (when they have covers)
    document.querySelectorAll('.knowledge-hub-card[data-cover-image]').forEach(function(card) {
        const imageUrl = card.getAttribute('data-cover-image');
        if (imageUrl) {
            card.style.backgroundImage = 'url(' + imageUrl + ')';
            card.style.backgroundSize = 'cover';
            card.style.backgroundPosition = 'center';
        }
    });

    // Task cards below hero: hide on click and show "Well done" when none left
    const taskContainer = document.querySelector('.hero-products-showcase');
    const emptyMessage = document.getElementById('task-empty-message');

    const updateTaskEmptyState = () => {
        if (!taskContainer) {
            // No grid on page – just ensure message is visible if it exists
            if (emptyMessage) emptyMessage.style.display = 'flex';
            return;
        }
        const remainingTasks = taskContainer.querySelectorAll('.product-bottle-link');
        if (remainingTasks.length === 0) {
            taskContainer.style.display = 'none';
            if (emptyMessage) emptyMessage.style.display = 'flex';
        } else {
            taskContainer.style.display = 'flex';
            if (emptyMessage) emptyMessage.style.display = 'none';
        }
    };

    if (taskContainer) {
        taskContainer.querySelectorAll('.product-bottle-link').forEach(function(link) {
            link.addEventListener('click', function() {
                // Hide this task card immediately; navigation continues normally
                link.remove();
                updateTaskEmptyState();
            });
        });
    }

    // Initialize empty state visibility correctly on page load
    updateTaskEmptyState();
});
</script>
{% endblock %}
