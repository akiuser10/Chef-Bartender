{% extends "base.html" %}
{% block page_panel %}
<div class="panel-header">
    <h2>Weekly Cold Storage Temperature Log</h2>
    <p>Week of {{ week_start.strftime('%B %d, %Y') }}</p>
</div>

<div class="page-panel">
    <div class="section-container">
        <form method="POST" class="form-container">
            <!-- Metadata Section -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="margin-top: 0;">Log Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="bar_name">Bar / Outlet Name *</label>
                        <input type="text" id="bar_name" name="bar_name" class="form-input" required value="{{ metadata.bar_name }}">
                    </div>
                    <div class="form-group">
                        <label for="location">Location *</label>
                        <input type="text" id="location" name="location" class="form-input" required value="{{ metadata.location }}">
                    </div>
                    <div class="form-group">
                        <label for="checked_by">Checked By *</label>
                        <input type="text" id="checked_by" name="checked_by" class="form-input" required value="{{ metadata.checked_by }}">
                    </div>
                    <div class="form-group">
                        <label for="week_start">Week Start Date</label>
                        <input type="date" id="week_start" name="week_start" class="form-input" value="{{ week_start.strftime('%Y-%m-%d') }}" readonly style="background: #e9e9e9;">
                    </div>
                </div>
            </div>

            <!-- Weekly Temperature Table -->
            <div style="overflow-x: auto; margin-bottom: 30px;">
                <table class="form-table" style="min-width: 800px;">
                    <thead>
                        <tr>
                            <th rowspan="2" style="min-width: 100px;">Day / Time</th>
                            {% for unit in units %}
                            <th colspan="2" style="min-width: 150px;">{{ unit.unit_number }}</th>
                            {% endfor %}
                            <th rowspan="2" style="min-width: 200px;">Corrective Action / Remarks</th>
                        </tr>
                        <tr>
                            {% for unit in units %}
                            <th style="font-size: 0.85em; font-weight: normal;">
                                {% set min_temp, max_temp = unit.get_temp_range() %}
                                {% if min_temp is not none and max_temp is not none %}
                                    Temp (째C)<br><small>{{ min_temp }}째 to {{ max_temp }}째</small>
                                {% else %}
                                    Temp (째C)
                                {% endif %}
                            </th>
                            <th style="font-size: 0.85em; font-weight: normal;">Action</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in days %}
                            {% set day_idx = loop.index0 %}
                            {% set day_date = week_dates[day_idx] %}
                            {% for time_slot in time_slots %}
                            <tr>
                                {% if loop.first %}
                                <td rowspan="{{ time_slots|length }}" style="vertical-align: middle; font-weight: bold;">
                                    {{ day }}<br><small>{{ day_date.strftime('%b %d') }}</small>
                                </td>
                                {% endif %}
                                <td style="background: #f5f5f5; font-weight: 500;">{{ time_slot }}</td>
                                {% for unit in units %}
                                <td>
                                    {% set log_key = (day_date, time_slot, unit.id) %}
                                    {% set existing_log = log_dict.get(log_key) %}
                                    <input type="number" 
                                           name="temp_{{ day_idx }}_{{ time_slot }}_{{ unit.id }}" 
                                           class="form-input temp-input" 
                                           step="0.1" 
                                           value="{% if existing_log %}{{ existing_log.temperature }}{% endif %}"
                                           data-unit-id="{{ unit.id }}"
                                           data-min="{{ unit.get_temp_range()[0] if unit.get_temp_range()[0] is not none else '' }}"
                                           data-max="{{ unit.get_temp_range()[1] if unit.get_temp_range()[1] is not none else '' }}"
                                           style="width: 100%; text-align: center;"
                                           onchange="checkTemperature(this)">
                                </td>
                                <td>
                                    <input type="text" 
                                           name="action_{{ day_idx }}_{{ time_slot }}_{{ unit.id }}" 
                                           class="form-input action-input" 
                                           value="{% if existing_log %}{{ existing_log.corrective_action or '' }}{% endif %}"
                                           placeholder="If out of range"
                                           style="width: 100%; font-size: 0.9em;">
                                </td>
                                {% endfor %}
                                <td>
                                    <textarea name="remarks_{{ day_idx }}_{{ time_slot }}" 
                                              class="form-input" 
                                              rows="1" 
                                              style="width: 100%; font-size: 0.9em; min-height: 35px;"
                                              placeholder="General remarks"></textarea>
                                </td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Supervisor Verification -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0;">Supervisor / Manager Verification</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="supervisor_name">Supervisor Name</label>
                        <input type="text" id="supervisor_name" name="supervisor_name" class="form-input" value="{{ metadata.supervisor_name }}">
                    </div>
                    <div class="form-group">
                        <label for="supervisor_signature">Signature</label>
                        <input type="text" id="supervisor_signature" name="supervisor_signature" class="form-input" value="{{ metadata.supervisor_signature }}">
                    </div>
                    <div class="form-group">
                        <label for="supervisor_date">Date</label>
                        <input type="date" id="supervisor_date" name="supervisor_date" class="form-input" value="{{ metadata.supervisor_date }}">
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Weekly Log</button>
                <a href="{{ url_for('checklist.temperature_log_index') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
function checkTemperature(input) {
    const unitId = input.dataset.unitId;
    const minTemp = parseFloat(input.dataset.min) || -Infinity;
    const maxTemp = parseFloat(input.dataset.max) || Infinity;
    const temp = parseFloat(input.value);
    
    if (isNaN(temp)) {
        input.style.backgroundColor = '';
        return;
    }
    
    const actionInput = input.closest('tr').querySelector(`input[name*="action_"][name*="_${unitId}"]`);
    
    if (temp < minTemp || temp > maxTemp) {
        input.style.backgroundColor = '#ffebee';
        input.style.borderColor = '#f44336';
        if (actionInput) {
            actionInput.placeholder = 'Required: Temperature out of range';
            actionInput.style.backgroundColor = '#fff3cd';
        }
    } else {
        input.style.backgroundColor = '#e8f5e9';
        input.style.borderColor = '#4caf50';
        if (actionInput) {
            actionInput.placeholder = 'If out of range';
            actionInput.style.backgroundColor = '';
        }
    }
}

// Check all existing temperatures on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.temp-input').forEach(input => {
        if (input.value) {
            checkTemperature(input);
        }
    });
});
</script>

<style>
@media print {
    .form-actions, .panel-header, .main-nav, .site-header {
        display: none;
    }
}
</style>
{% endblock %}

