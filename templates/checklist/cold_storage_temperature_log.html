{% extends "base.html" %}
{% block page_panel %}
<script>
    // Pass user initials to JavaScript
    window.userInitials = '{{ (current_user.first_name[0] if current_user.first_name else "") + (current_user.last_name[0] if current_user.last_name else "") if current_user.is_authenticated else "" }}';
    // Fallback to username first letter if no name
    if (!window.userInitials && {{ 'true' if current_user.is_authenticated else 'false' }}) {
        window.userInitials = '{{ current_user.username[0].upper() if current_user.username else "" }}';
    }
</script>
<div class="panel-header">
    <h2>Cold Storage Temperature Log – Unit Wise (HACCP)</h2>
</div>

<div class="cold-storage-container">
    <!-- Date and Time Selection -->
    <div class="date-time-selection">
        <div class="selection-group">
            <label for="log-date">Date:</label>
            <input type="date" id="log-date" value="{{ today.isoformat() }}" class="date-input">
        </div>
        <div class="selection-group">
            <label for="log-time">Time:</label>
            <select id="log-time" class="time-select">
                <option value="10:00 AM">10:00 AM</option>
                <option value="02:00 PM">02:00 PM</option>
                <option value="06:00 PM">06:00 PM</option>
                <option value="10:00 PM">10:00 PM</option>
            </select>
        </div>
        <div class="selection-group">
            {% if current_user.user_role == 'Manager' %}
            <button type="button" id="add-unit-btn" class="btn-primary">Add New Unit</button>
            {% endif %}
            <button type="button" id="generate-pdf-btn" class="btn-secondary">Generate PDF</button>
        </div>
    </div>

    <!-- Temperature Log Section -->
    <div class="temperature-log-section">
        <div id="date-display" class="date-display">
            <strong>DATE:</strong> <span id="display-date">—</span>
            <strong>SELECTED TIME FOR ENTRY:</strong> <span id="display-time">—</span>
        </div>
        
        <div id="units-tables-container">
            <!-- Individual unit tables will be populated by JavaScript -->
        </div>
        
        <div class="action-buttons-section">
            <button id="update-temperature-btn" class="btn-primary">Update Temperature</button>
            <button id="checklist-download-btn" class="btn-secondary hidden">Checklist Download</button>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="empty-state">
        <p>No units found. Please add units to start logging temperatures.</p>
    </div>
</div>

<!-- Add/Edit Unit Form Modal -->
<div id="unit-form-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="unit-form-title">Add Unit</h3>
            <button class="modal-close" id="unit-form-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="unit-form">
                <input type="hidden" id="unit-id" name="unit_id">
                <div class="form-group">
                    <label for="unit-number">Unit Number *</label>
                    <input type="text" id="unit-number" name="unit_number" required>
                </div>
                <div class="form-group">
                    <label for="unit-location">Location *</label>
                    <input type="text" id="unit-location" name="location" required>
                </div>
                <div class="form-group">
                    <label for="unit-type">Unit Type *</label>
                    <select id="unit-type" name="unit_type" required>
                        <option value="">-- Select Type --</option>
                        <option value="Refrigerator">Refrigerator</option>
                        <option value="Freezer">Freezer</option>
                        <option value="Wine Chiller">Wine Chiller</option>
                    </select>
                </div>
                <div class="form-group hidden" id="wine-chiller-temps">
                    <label for="min-temp">Minimum Temperature (°C)</label>
                    <input type="number" id="min-temp" name="min_temp" step="0.1">
                    <label for="max-temp">Maximum Temperature (°C)</label>
                    <input type="number" id="max-temp" name="max_temp" step="0.1">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Save</button>
                    <button type="button" class="btn-secondary" id="cancel-unit-form">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Unit Management Modal -->
<div id="unit-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Manage Units</h3>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="unit-list-container">
                <!-- Unit list will be populated here -->
            </div>
            <button id="manage-add-unit-btn" class="btn-primary">Add New Unit</button>
        </div>
    </div>
</div>

<!-- Checklist Download Modal -->
<div id="checklist-download-modal" class="modal hidden">
    <div class="modal-content checklist-modal-content">
        <div class="modal-header">
            <h3>Download Checklist PDF</h3>
            <button class="modal-close" id="checklist-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="checklist-form">
                <div class="form-group">
                    <label>Select Unit Numbers *</label>
                    <div id="checklist-unit-checkboxes" class="checkbox-group">
                        <!-- Checkboxes will be populated by JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Select Dates *</label>
                    <div class="date-range-selection">
                        <div>
                            <label for="checklist-start-date">Start Date:</label>
                            <input type="date" id="checklist-start-date" name="start_date" required>
                        </div>
                        <div>
                            <label for="checklist-end-date">End Date:</label>
                            <input type="date" id="checklist-end-date" name="end_date" required>
                        </div>
                    </div>
                    <small class="form-help">All dates between start and end date will be included</small>
                </div>
                <div class="form-group">
                    <label>Select Times *</label>
                    <div id="checklist-time-checkboxes" class="checkbox-group">
                        <label><input type="checkbox" name="times" value="10:00 AM" checked> 10:00 AM</label>
                        <label><input type="checkbox" name="times" value="02:00 PM" checked> 02:00 PM</label>
                        <label><input type="checkbox" name="times" value="06:00 PM" checked> 06:00 PM</label>
                        <label><input type="checkbox" name="times" value="10:00 PM" checked> 10:00 PM</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Generate PDF</button>
                    <button type="button" class="btn-secondary" id="cancel-checklist">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- PDF Generation Modal (Legacy) -->
<div id="pdf-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Generate PDF Report</h3>
            <button class="modal-close" id="pdf-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="pdf-form">
                <div class="form-group">
                    <label>Report Type:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="report_type" value="daily" checked> Single Date</label>
                        <label><input type="radio" name="report_type" value="weekly"> Week Range</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="pdf-start-date">Start Date *</label>
                    <input type="date" id="pdf-start-date" name="start_date" required>
                </div>
                <div class="form-group hidden" id="pdf-end-date-group">
                    <label for="pdf-end-date">End Date *</label>
                    <input type="date" id="pdf-end-date" name="end_date">
                </div>
                <div class="form-group">
                    <label>Select Units:</label>
                    <div id="pdf-unit-checkboxes">
                        <!-- Checkboxes will be populated by JavaScript -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Generate PDF</button>
                    <button type="button" class="btn-secondary" id="cancel-pdf">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='cold_storage_temperature_log.js') }}"></script>
{% endblock %}
